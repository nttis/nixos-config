{
  "name": "Build and push system to cache",

  "on": {
    "push": {
      "branches": "main"
    },

    "workflow_dispatch": {}
  },

  "jobs": {
    "build": {
      "name": "Build system",
      "runs-on": "ubuntu-latest",
      "steps": [
        {
          "name": "Remove Hosted Tool Cache",
          "run": "sudo rm -rf /opt/hostedtoolcache"
        },

        # Commented out for now because it takes too long to remove
        # while we don't need the space yet
        # {
        #   "name": "Remove Android SDKs",
        #   "run": "sudo rm -rf /usr/local/lib/android"
        # },

        {
          "name": "Remove GHC",
          "run": "sudo rm -rf /usr/local/.ghcup"
        },

        {
          "name": "Install Nix",
          "uses": "cachix/install-nix-action@17fe5fb4a23ad6cbbe47d6b3f359611ad276644c", # v31.4.0
          "with": {
            "github_access_token": "${{ secrets.GITHUB_TOKEN }}"
          }
        },
        
        {
          "name": "Install Cachix",
          "uses": "cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad", # v16
          "with": {
            "name": "nttis",
            "authToken": "${{ secrets.CACHIX_AUTH_TOKEN }}"
          }
        },

        {
          "name": "Checkout",
          "uses": "actions/checkout@v4"
        },

        {
          "name": "Build",
          "run": "nix build .#nixosConfigurations.laptop.config.system.build.toplevel"
        },
      ]
    }
  }
}
